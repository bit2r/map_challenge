---
title: "지도제작 대회"
subtitle: "수도권 국힘의원"
description: |
  수도권 국민의힘 의원
author:
  - name: 이광춘
    url: https://www.linkedin.com/in/kwangchunlee/
    affiliation: 한국 R 사용자회
    affiliation-url: https://github.com/bit2r
title-block-banner: true
format:
  html:
    theme: flatly
    code-fold: true
    code-overflow: wrap
    toc: true
    toc-depth: 3
    toc-title: 목차
    number-sections: true
    highlight-style: github    
    self-contained: false
    default-image-extension: jpg
filters:
   - lightbox
lightbox: auto
link-citations: true
knitr:
  opts_chunk: 
    eval: true
    message: false
    warning: false
    collapse: true
    comment: "#>" 
    R.options:
      knitr.graphics.auto_pdf: true
editor_options: 
  chunk_output_type: console
---

# 데이터셋

## 서울특별시

```{r}
library(tidyverse)

elected_tbl <- 
  read_rds("data/total_elected_all.rds")

seoul_tbl <- elected_tbl |> 
  filter(sgId %in% c("20160413", "20200415", "20120411", "20080409", "20040415")) |> 
  filter(str_detect(sdName, "서울")) |>
  select(result) |> 
  unnest(result) |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",                 TRUE ~ "기타")) |> 
  count(sgId, 정당명) |> 
  pivot_wider(names_from = 정당명, values_from = n, values_fill = 0) |> 
  mutate(합계 = 국민의힘 + 민주당 + 기타)

```

## 경기도

```{r}
gg_tbl <- elected_tbl |> 
  filter(sgId %in% c("20160413", "20200415", "20120411", "20080409", "20040415")) |> 
  filter(str_detect(sdName, "경기")) |>
  select(result) |> 
  unnest(result) |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",                 TRUE ~ "기타")) |> 
  count(sgId, 정당명) |> 
  pivot_wider(names_from = 정당명, values_from = n, values_fill = 0) |> 
  mutate(합계 = 국민의힘 + 민주당 + 기타)

```



# 분석

## 서울특별시

```{r}
library(gt)
library(gtExtras)

seoul_tbl |> 
  gt(rowname_col = "sgId") |> 
  gt_theme_538() |> 
  cols_align("center") |> 
  cols_label(
    sgId = "선거명"
  ) |> 
  ## 표 전체 합계 -------------------------------------
  grand_summary_rows(
    columns = c(국민의힘, 민주당, 기타, 합계),
    fns =  list(label = "총계", fn = "sum"),
    fmt = ~ fmt_integer(.),
    side = "top"
  )  |> 
  tab_header(
    title = md("서울특별시 국회의원 역대 당선자 현황"),
    subtitle = md("중앙선거관리위원회 선거통계")
  ) |> 
  tab_spanner(
    label = "정당명",
    columns = c(
      국민의힘, 민주당, 기타
    )
  )  |> 
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_stub_grand_summary()
  )  
```

## 경기도

```{r}
gg_tbl |> 
  gt(rowname_col = "sgId") |> 
  gt_theme_538() |> 
  cols_align("center") |> 
  cols_label(
    sgId = "선거명"
  ) |> 
  ## 표 전체 합계 -------------------------------------
  grand_summary_rows(
    columns = c(국민의힘, 민주당, 기타, 합계),
    fns =  list(label = "총계", fn = "sum"),
    fmt = ~ fmt_integer(.),
    side = "top"
  )  |> 
  tab_header(
    title = md("경기도 국회의원 역대 당선자 현황"),
    subtitle = md("중앙선거관리위원회 선거통계")
  ) |> 
  tab_spanner(
    label = "정당명",
    columns = c(
      국민의힘, 민주당, 기타
    )
  )  |> 
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_stub_grand_summary()
  )  
```

# 지도

## 서울특별시

```{r}
library(sf)

precinct <- st_read("data/2020_21_elec_253.json") |> 
  st_set_crs(4326)

seoul_precinct <- precinct |> 
  filter(SGG_1 == "서울") 

st_geometry(seoul_precinct) |> plot()
```


```{r}
seoul_party_tbl <- elected_tbl |> 
  filter(sgId %in% c("20200415")) |> 
  filter(str_detect(sdName, "서울")) |>
  select(result) |> 
  unnest(result) |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",                 TRUE ~ "기타")) |> 
  select(sggName, wiwName, giho, jdName, name, dugsu, dugyul, 정당명)

seoul_precinct_party <- seoul_precinct |> 
  mutate(sggName = str_remove(SGG_2, "서울특별시 ")) |> 
  left_join(seoul_party_tbl)
```


```{r}
seoul_precinct_party |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",
    jdName %in% c("정의당") ~ "정의당",
    TRUE ~ "기타")) |>   
  ggplot() +
    geom_sf(aes(geometry = geometry, fill = 정당명), alpha =0.2) +
    scale_fill_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red",
                                  "정의당" = "yellow")) +
    theme_void() +
    theme(legend.position = "top") +
    labs(fill = "정당명") +
    ggrepel::geom_text_repel(
        aes(label = sggName, geometry = geometry,
            color = 정당명), stat = "sf_coordinates", 
        min.segment.length = 1, size = 4, max.overlaps = Inf,
        show.legend = FALSE, fontface="bold"
    ) +
    scale_color_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red",
                                  "정의당" = "black"))
  
```

## 경기도

```{r}
gg_precinct <- precinct |> 
  filter(SGG_1 == "경기") 

st_geometry(gg_precinct) |> plot()
```


```{r}
gg_party_tbl <- elected_tbl |> 
  filter(sgId %in% c("20200415")) |> 
  filter(str_detect(sdName, "경기")) |>
  select(result) |> 
  unnest(result) |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",                 TRUE ~ "기타")) |> 
  select(sggName, wiwName, giho, jdName, name, dugsu, dugyul, 정당명)

gg_precinct_party <- gg_precinct |> 
  mutate(sggName = str_remove(SGG_2, "경기도 ")) |> 
  left_join(gg_party_tbl)
```


```{r}
sf_use_s2(FALSE)
gg_precinct_party |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",
    jdName %in% c("정의당") ~ "정의당",
    TRUE ~ "기타")) |>   
  ggplot() +
    geom_sf(aes(geometry = geometry, fill = 정당명), alpha =0.2) +
    scale_fill_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red",
                                  "정의당" = "yellow")) +
    theme_void() +
    theme(legend.position = "top") +
    labs(fill = "정당명") +
    ggrepel::geom_text_repel(
        aes(label = sggName, geometry = geometry,
            color = 정당명), stat = "sf_coordinates", 
        min.segment.length = 1, size = 3, max.overlaps = Inf,
        show.legend = FALSE, fontface="bold"
    ) +
    scale_color_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red",
                                  "정의당" = "black"))
  
```

# 득표차

```{r}
#| eval: false
seoul_krvote <- krvote::general_2020 |> 
  filter(시도 == "서울") |> 
  unnest(data) |> 
  mutate(구분 = ifelse(stringi::stri_enc_isutf8(구분), 구분,
                     iconv(구분, from = "euc-kr", to = "utf-8"))) 

seoul_krvote_tbl <- seoul_krvote |> 
  group_by(선거구, 구분) |> 
  summarise(사람수 = sum(사람수)) |> 
  ungroup() |> 
  mutate(정당 = case_when(
    str_detect(구분, "김성식") ~ "국민의힘",
    str_detect(구분, "더불어민주당") ~ "민주당",
    str_detect(구분, "미래통합당") ~ "국민의힘",
    str_detect(구분, "선거인수") ~ "선거인수",
    str_detect(구분, "투표수") ~ "투표수",
    구분 == "계" ~ "계",
    TRUE ~ "기타")) |>  
  filter(정당 %in% c("민주당", "국민의힘", "계")) |> 
  select(선거구, 정당, 사람수) |> 
  pivot_wider(names_from = 정당, values_from = 사람수) |> 
  mutate(민주_득표율 = 민주당 / 계,
         국민_득표율 = 국민의힘 / 계) |> 
  mutate(득표차 = 민주_득표율 - 국민_득표율) |> 
  mutate(선거구 = ifelse(str_detect(선거구, "_"), 
                      str_extract(선거구, "(.*?)_") |> str_remove("_"), 선거구))
  
seoul_krvote_tbl |> 
  write_rds("data/seoul_krvote_tbl.rds")
```


```{r}
seoul_krvote_tbl <- 
  read_rds("data/seoul_krvote_tbl.rds")

seoul_diff_sf <- seoul_precinct_party |> 
  left_join(seoul_krvote_tbl, by = c("sggName" = "선거구")) 

seoul_diff_sf |> 
  ggplot() +
    geom_sf(aes(geometry = geometry, fill = 득표차, color = 정당명), lwd  = 1) +
    scale_fill_gradient2(high = "blue", mid = "gray100", low = "red") +
    theme_void() +
    theme(legend.position = "top") +
    labs(fill = "득표차") +
    ggrepel::geom_text_repel(
        aes(label = str_glue("{sggName}\n{scales::percent(득표차, accuracy=0.1)}"), geometry = geometry), 
        stat = "sf_coordinates", 
        min.segment.length = 0, size = 4, max.overlaps = Inf,
        show.legend = FALSE, fontface="bold", color = "black"
    ) +
    scale_color_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red"))  
```

# 강서구

```{r}
seoul_diff_sf |> 
  filter( str_detect(sggName, "^강서")) |> 
  ggplot() +
    geom_sf(aes(geometry = geometry, fill = 득표차, color = 정당명), lwd  = 1) +
    scale_fill_gradient2(high = "blue", mid = "gray100", low = "red") +
    theme_void() +
    theme(legend.position = "top") +
    labs(fill = "득표차") +
    geom_text(
        aes(label = str_glue("{sggName}\n{scales::percent(득표차, accuracy=0.1)}"), geometry = geometry), 
        stat = "sf_coordinates", 
        show.legend = FALSE, fontface="bold", color = "black"
    ) +
    scale_color_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red"))  
```


