---
title: "지도제작 대회"
subtitle: "수도권 국힘의원"
description: |
  수도권 국민의힘 의원
author:
  - name: 이광춘
    url: https://www.linkedin.com/in/kwangchunlee/
    affiliation: 한국 R 사용자회
    affiliation-url: https://github.com/bit2r
title-block-banner: true
format:
  html:
    theme: flatly
    code-fold: true
    code-overflow: wrap
    toc: true
    toc-depth: 3
    toc-title: 목차
    number-sections: true
    highlight-style: github    
    self-contained: false
    default-image-extension: jpg
filters:
   - lightbox
lightbox: auto
link-citations: true
knitr:
  opts_chunk: 
    eval: true
    message: false
    warning: false
    collapse: true
    comment: "#>" 
    R.options:
      knitr.graphics.auto_pdf: true
editor_options: 
  chunk_output_type: console
---

# 데이터셋

## 서울특별시

```{r}
library(tidyverse)

elected_tbl <- 
  read_rds("data/total_elected_all.rds")

seoul_tbl <- elected_tbl |> 
  filter(sgId %in% c("20160413", "20200415", "20120411", "20080409", "20040415")) |> 
  filter(str_detect(sdName, "서울")) |>
  select(result) |> 
  unnest(result) |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",                 TRUE ~ "기타")) |> 
  count(sgId, 정당명) |> 
  pivot_wider(names_from = 정당명, values_from = n, values_fill = 0) |> 
  mutate(합계 = 국민의힘 + 민주당 + 기타)

```

## 경기도

```{r}
gg_tbl <- elected_tbl |> 
  filter(sgId %in% c("20160413", "20200415", "20120411", "20080409", "20040415")) |> 
  filter(str_detect(sdName, "경기")) |>
  select(result) |> 
  unnest(result) |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",                 TRUE ~ "기타")) |> 
  count(sgId, 정당명) |> 
  pivot_wider(names_from = 정당명, values_from = n, values_fill = 0) |> 
  mutate(합계 = 국민의힘 + 민주당 + 기타)

```



# 분석

## 서울특별시

```{r}
library(gt)
library(gtExtras)

seoul_tbl |> 
  gt(rowname_col = "sgId") |> 
  gt_theme_538() |> 
  cols_align("center") |> 
  cols_label(
    sgId = "선거명"
  ) |> 
  ## 표 전체 합계 -------------------------------------
  grand_summary_rows(
    columns = c(국민의힘, 민주당, 기타, 합계),
    fns =  list(label = "총계", fn = "sum"),
    fmt = ~ fmt_integer(.),
    side = "top"
  )  |> 
  tab_header(
    title = md("서울특별시 국회의원 역대 당선자 현황"),
    subtitle = md("중앙선거관리위원회 선거통계")
  ) |> 
  tab_spanner(
    label = "정당명",
    columns = c(
      국민의힘, 민주당, 기타
    )
  )  |> 
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_stub_grand_summary()
  )  
```

## 경기도

```{r}
gg_tbl |> 
  gt(rowname_col = "sgId") |> 
  gt_theme_538() |> 
  cols_align("center") |> 
  cols_label(
    sgId = "선거명"
  ) |> 
  ## 표 전체 합계 -------------------------------------
  grand_summary_rows(
    columns = c(국민의힘, 민주당, 기타, 합계),
    fns =  list(label = "총계", fn = "sum"),
    fmt = ~ fmt_integer(.),
    side = "top"
  )  |> 
  tab_header(
    title = md("경기도 국회의원 역대 당선자 현황"),
    subtitle = md("중앙선거관리위원회 선거통계")
  ) |> 
  tab_spanner(
    label = "정당명",
    columns = c(
      국민의힘, 민주당, 기타
    )
  )  |> 
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_stub_grand_summary()
  )  
```

# 지도

## 서울특별시

```{r}
library(sf)

precinct <- st_read("data/2020_21_elec_253.json") |> 
  st_set_crs(4326)

seoul_precinct <- precinct |> 
  filter(SGG_1 == "서울") 

st_geometry(seoul_precinct) |> plot()
```


```{r}
seoul_party_tbl <- elected_tbl |> 
  filter(sgId %in% c("20200415")) |> 
  filter(str_detect(sdName, "서울")) |>
  select(result) |> 
  unnest(result) |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",                 TRUE ~ "기타")) |> 
  select(sggName, wiwName, giho, jdName, name, dugsu, dugyul, 정당명)

seoul_precinct_party <- seoul_precinct |> 
  mutate(sggName = str_remove(SGG_2, "서울특별시 ")) |> 
  left_join(seoul_party_tbl)
```


```{r}
seoul_precinct_party |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",
    jdName %in% c("정의당") ~ "정의당",
    TRUE ~ "기타")) |>   
  ggplot() +
    geom_sf(aes(geometry = geometry, fill = 정당명), alpha =0.2) +
    scale_fill_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red",
                                  "정의당" = "yellow")) +
    theme_void() +
    theme(legend.position = "top") +
    labs(fill = "정당명") +
    ggrepel::geom_text_repel(
        aes(label = sggName, geometry = geometry,
            color = 정당명), stat = "sf_coordinates", 
        min.segment.length = 1, size = 4, max.overlaps = Inf,
        show.legend = FALSE, fontface="bold"
    ) +
    scale_color_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red",
                                  "정의당" = "black"))
  
```

## 경기도

```{r}
gg_precinct <- precinct |> 
  filter(SGG_1 == "경기") 

st_geometry(gg_precinct) |> plot()
```


```{r}
gg_party_tbl <- elected_tbl |> 
  filter(sgId %in% c("20200415")) |> 
  filter(str_detect(sdName, "경기")) |>
  select(result) |> 
  unnest(result) |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",                 TRUE ~ "기타")) |> 
  select(sggName, wiwName, giho, jdName, name, dugsu, dugyul, 정당명)

gg_precinct_party <- gg_precinct |> 
  mutate(sggName = str_remove(SGG_2, "경기도 ")) |> 
  left_join(gg_party_tbl)
```


```{r}
sf_use_s2(FALSE)
gg_precinct_party |> 
  mutate(정당명 = case_when(
    jdName %in% c("한나라당", "새누리당", "미래통합당") ~ "국민의힘",
    jdName %in% c("더불어민주당", "열린우리당", "통합민주당", "민주통합당") ~ "민주당",
    jdName %in% c("정의당") ~ "정의당",
    TRUE ~ "기타")) |>   
  ggplot() +
    geom_sf(aes(geometry = geometry, fill = 정당명), alpha =0.2) +
    scale_fill_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red",
                                  "정의당" = "yellow")) +
    theme_void() +
    theme(legend.position = "top") +
    labs(fill = "정당명") +
    ggrepel::geom_text_repel(
        aes(label = sggName, geometry = geometry,
            color = 정당명), stat = "sf_coordinates", 
        min.segment.length = 1, size = 3, max.overlaps = Inf,
        show.legend = FALSE, fontface="bold"
    ) +
    scale_color_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red",
                                  "정의당" = "black"))
  
```


