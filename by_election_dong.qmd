---
title: "지도제작 대회"
subtitle: "재보궐: 강서구청장(동별)"
description: |
  강서구청장 재보궐 선거 동별 상세 분석
author:
  - name: 이광춘
    url: https://www.linkedin.com/in/kwangchunlee/
    affiliation: 한국 R 사용자회
    affiliation-url: https://github.com/bit2r
title-block-banner: true
format:
  html:
    theme: flatly
    code-fold: true
    code-overflow: wrap
    toc: true
    toc-depth: 3
    toc-title: 목차
    number-sections: true
    highlight-style: github    
    self-contained: false
    default-image-extension: jpg
filters:
   - lightbox
lightbox: auto
link-citations: true
knitr:
  opts_chunk: 
    eval: false
    message: false
    warning: false
    collapse: true
    comment: "#>" 
    R.options:
      knitr.graphics.auto_pdf: true
editor_options: 
  chunk_output_type: console
---

# 데이터셋



### 구시군의 장

```{r}
#| eval: false

library(tidyverse)
library(ggalt)
library(ggrepel)
library(extrafont)
loadfonts()
library(ggtext)

votes_tbl <- krvote::local_sgg_20220601 |> 
  filter(시도명 == "서울특별시",
         구시군명 == "강서구",) |> 
  mutate(득표 = parse_number(득표),
         읍면동명 = case_when(str_detect(읍면동명, "관외|거소|잘못") ~ "관외사전거소",
                              TRUE ~ 읍면동명)) |> 
  group_by(후보, 읍면동명) |> 
  summarise(득표 = sum(득표)) |> 
  mutate(후보 = case_when(str_detect(후보, "김승현") ~ "민주당",
                          str_detect(후보, "김태우") ~ "국민의힘",
                          TRUE ~ "그외/기타")) |> 
  ungroup() |> 
  arrange(읍면동명, 후보) |> 
  mutate(paired = rep(1:(n()/2),each=2)) |> 
  ungroup() |> 
  pivot_wider(names_from = 후보,
              values_from = 득표) |> 
  mutate(차이 = 민주당 - 국민의힘,
         합계 = 민주당 + 국민의힘)  |> 
  mutate(label_color = ifelse(차이 > 0, "blue", "red"))


## y 축 읍면동 색상을 지정 -------------
emd_colors <- votes_tbl |> 
  mutate(읍면동명 = fct_reorder(읍면동명, 합계)) |> 
  arrange(읍면동명) |> 
  pull(label_color)


## 우측 상자 비율과 득표수 -------------
rates_tbl <- votes_tbl |> 
  mutate(민주_득표율 = 민주당/합계,
         국힘_득표율 = 국민의힘/합계,
         득표율차이 = 민주_득표율 - 국힘_득표율) |> 
  pivot_longer(민주_득표율:국힘_득표율, names_to = "정당", values_to = "득표율")

rect_tbl <- rates_tbl |> 
  select(읍면동명, 차이, 득표율차이) |> 
  distinct()

total_tbl <- votes_tbl |> 
  summarise(국민의힘 = sum(국민의힘),
            민주당 = sum(민주당)) |> 
  mutate(득표차이 = abs(국민의힘-민주당),
         득표율차이 = abs(득표차이 / (국민의힘+민주당)))


강서구청장_gg <- votes_tbl |> 
  pivot_longer(민주당:국민의힘, names_to = "정당", values_to = "득표")  |> 
  ggplot(aes(x = fct_reorder(읍면동명, 합계), y = 득표, color = 정당)) +
    geom_line(aes(group = paired), color = "gray50") +
    geom_point(size = 2) +
    coord_flip(clip="off") +
    theme(legend.position = "top",
          axis.text.y = element_text(colour = emd_colors)) +
    scale_color_manual(values = c("민주당" = "blue",
                                  "국민의힘" = "red")) +
    labs(x = "",
         y = "득표수",
         title = "강서구청장 제8회 지방선거 동별 득표현황") +
    scale_y_continuous(label = scales::comma) +
    guides(colour = guide_legend(nrow = 1)) +
    scale_y_continuous(labels = scales::comma, limits = c(0, 20000)) +
     # 득표율 ----------------------
     geom_text_repel(data = rates_tbl |> filter(str_detect(정당, "민주")), 
              aes(label=glue::glue("{scales::percent(득표율, accuracy=0.1)}"),
                  y = 민주당, x = 읍면동명), hjust = "outward", direction = "x", vjust = 1.5,
                  fontface="bold", size=2.7, color = "blue") +
     geom_text_repel(data = rates_tbl |> filter(str_detect(정당, "국힘")), 
              aes(label=glue::glue("{scales::percent(득표율, accuracy=0.1)}"),
                  y = 국민의힘, x = 읍면동명), hjust = "outward", direction = "x", vjust = -0.5,
                  fontface="bold", size=2.7, color = "red") +
     # 차이 ----------------------
     geom_rect(aes(ymin=18000, ymax=20000, xmin=-Inf, xmax=Inf), fill="gray90", color="gray90") +
     geom_text(data = rect_tbl, aes(label=glue::glue("{scales::comma(abs(차이))} / {scales::percent(abs(득표율차이), accuracy=0.1)}"),
                   y = 19000, x = 읍면동명),
                   fontface="bold", size = 3.5, color = "black", family ="MaruBuri") +
     annotate("text", x=22.5, y=19000, size = 5, family ="MaruBuri",fontface="bold",
              label=str_glue("득표차/득표율차\n",
                             "{scales::comma(total_tbl$득표차이)} / {scales::percent(total_tbl$득표율차이,0.1)}") )
  
강서구청장_gg

ragg::agg_jpeg("images/강서구청장_지선_동별.jpeg",
              width = 10, height = 7, units = "in", res = 600)
강서구청장_gg
dev.off()

```


![](images/강서구청장_지선_동별.jpeg)
